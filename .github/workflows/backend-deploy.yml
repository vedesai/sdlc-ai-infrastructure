# AI Generated Code by Deloitte + Cursor (BEGIN)
name: Backend Deployment

on:
  push:
    branches: [main]
    paths: ['backend/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: sdlc-ai

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      - run: ./mvnw clean package -DskipTests -B
        working-directory: backend
      - id: version
        run: echo "version=$(date +%Y%m%d%H%M%S)-${{ github.run_number }}" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar

  docker:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend/target
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr
      - name: Build and push
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          ECR_REPO=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.PROJECT_NAME }}-${ENVIRONMENT}-backend \
            --query "Stacks[0].Outputs[?OutputKey=='ECRRepositoryUri'].OutputValue" \
            --output text)
          docker build -t ${ECR_REPO}:${VERSION} -t ${ECR_REPO}:latest backend/
          docker push ${ECR_REPO}:${VERSION}
          docker push ${ECR_REPO}:latest

  deploy:
    needs: [build, docker]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Deploy to ECS
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          CLUSTER=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.PROJECT_NAME }}-${ENVIRONMENT}-backend \
            --query "Stacks[0].Outputs[?OutputKey=='ECSClusterName'].OutputValue" \
            --output text)
          SERVICE=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.PROJECT_NAME }}-${ENVIRONMENT}-backend \
            --query "Stacks[0].Outputs[?OutputKey=='ECSServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster ${CLUSTER} --service ${SERVICE} --force-new-deployment
          aws ecs wait services-stable --cluster ${CLUSTER} --services ${SERVICE}
# AI Generated Code by Deloitte + Cursor (END)
